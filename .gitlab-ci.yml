stages:
  - Capacity
  - Provisioning
  - Release

before_script:
  - export BASE_URL=${BASE_URL:-$(echo $CI_PROJECT_URL |  cut -d'/' -f1-3)}
  - >
    if [ "$BASE_URL" == "https://gitlab.cncf.ci" ]; then
      export ENVIRONMENT="pd"
    elif [ "$BASE_URL" == "https://gitlab.staging.cncf.ci" ]; then
      export ENVIRONMENT="sg"
    elif [ "$BASE_URL" == "https://gitlab.dev.cncf.ci" ]; then
      export ENVIRONMENT="dv"
    elif [ "$BASE_URL" == "https://gitlab.cidev.cncf.ci" ]; then
      export ENVIRONMENT="ci"
    else
      echo "Environment unknown: $BASE_URL"
      exit 1
    fi

Check-Capacity:
  stage: Capacity
  image: debian:stretch
  script:
    - apt update && apt -y install jq curl
    - >
      if [ $CI_COMMIT_REF_NAME == "production" ]; then
         echo "Checking for reserved servers."
         export RESERVED=true
      else
         echo "Checking for on-demand servers."
         export RESERVED=false
      fi
    - ./capacity.sh
    - echo "TF_VAR_packet_facility=$FACILITY" > facility.env

  artifacts:
    name: "${CI_JOB_NAME}_${CI_COMMIT_REF_NAME}"
    untracked: true
    expire_in: 5 weeks
    paths:
      - facility.env

Provisioning:
  stage: Provisioning
  image:
    name: hashicorp/terraform:0.12.2
    entrypoint: [""]
  script:
    - source facility.env
    - >
      if [ $CI_COMMIT_REF_NAME == "production" ]; then
         echo "Write reserved node config"
         cp ./reserved_instances ./terraform/override.tf
      else
         echo "Skipping reservations"
      fi
    - cd terraform
    - terraform init -backend-config "bucket=${AWS_BUCKET}" -backend-config "key=aws-${TF_VAR_name}" -backend-config "region=${AWS_DEFAULT_REGION}"
    - terraform apply
  dependencies:
    - Check-Capacity
